1. 二进制分帧层    
* 帧（frame）  

帧类型又可以分为：  
DATA：用于传输HTTP消息体；
HEADERS：用于传输首部字段；
SETTINGS：用于约定客户端和服务端的配置数据。比如设置初识的双向流量控制窗口大小；
WINDOW_UPDATE：用于调整个别流或个别连接的流量
PRIORITY： 用于指定或重新指定引用资源的优先级。
RST_STREAM： 用于通知流的非正常终止。
PUSH_ PROMISE： 服务端推送许可。
PING： 用于计算往返时间，执行“ 活性” 检活。
GOAWAY： 用于通知对端停止在当前连接中创建流。  
* 消息（message）  
* 流（stream）  

帧可以乱序发送， 然后根据每个帧首部的流标识符重新组装。 

2. 多路复用共享连接  

基于二进制分帧层，HTTP 2.0可以在共享TCP连接的基础上，同时发送请求和响应。HTTP消息被分解为独立的帧，而不破坏消息本身的语义，交错发送出去，最后在另一端根据流ID和首部将它们重新组合起来。  
HTTP 1.x的pipeline机制，HTTP 1.x发起请求是串行的，  
```
浏览器对同一域名下的并发连接数量有限制，一般为6个，HTTP1中的Keep-Alive用于长连接而不必重新建立连接，然而keep-alive必须等本次请求彻底完成后才能发送下一个请求，而HTTP2的请求与响应以二进制帧的形式交错进行，只需建立一次连接，即一轮三次握手，实现多路复用。
```

3. 请求优先级

比如客户端优先级设置为.css>.js>.jpg（具体可参见《高性能网站建设指南》）， 服务端按优先级返回结果有利于高效利用底层连接，提高用户体验。 
问题：  
- 服务端是否支持请求优先级
- 会否引起队首阻塞问题，比如高优先级的慢响应请求会阻塞其他资源的交互。

4. 服务端推送  

HTTP 2.0增加了服务端推送功能，服务端可以根据客户端的请求，提前返回多个响应，推送额外的资源给客户端。  
PUSH_PROMISE帧是服务端向客户端有意推送资源的信号。  
* 如果客户端不需要服务端Push，可在SETTINGS帧中设定服务端流的值为0，禁用此功能

5. 首部压缩  

HTTP 1.x每一次通信（请求/响应）都会携带首部信息用于描述资源属性。HTTP 2.0在客户端和服务端之间使用“首部表”来跟踪和存储之前发送的键-值对。首部表在连接过程中始终存在，新增的键-值对会更新到表尾，因此，不需要每次通信都需要再携带首部。  
Index  
HTTP 2.0使用了首部压缩技术，压缩算法使用HPACK。可让报头更紧凑，更快速传输，有利于移动网络环境。   
*HTTP 2.0关注的是首部压缩，而我们常用的gzip等是报文内容（body）的压缩。二者不仅不冲突，且能够一起达到更好的压缩效果。*

6. 一个完整的HTTP 2.0通信过程
* 基于ALPN的协商过程  

支持HTTP 2.0的浏览器可以在TLS会话层自发完成和服务端的协议协商以确定是否使用HTTP 2.0通信。其原理是**TLS 1.2**中引入了扩展字段，以允许协议的扩展，其中ALPN协议（Application Layer Protocol Negotiation, 应用层协议协商, 前身是NPN）用于客户端和服务端的协议协商过程。 
服务端使用ALPN，监听443端口默认提高HTTP 1.1，并允许协商其他协议，比如SPDY和HTTP 2.0。

* 基于HTTP的协商过程  

客户端使用HTTP也可以开启HTTP 2.0通信。只不过因为HTTP 1. 0和HTTP 2. 0都使用同一个 端口（80）， 又没有服务器是否支持HTTP 2. 0的其他任何 信息，此时 客户端只能使用HTTP Upgrade机制（OkHttp, nghttp2等组件均可实现，也可以自己编码完成）通过协调确定适当的协

* 完整通信过程  

TCP连接建立  
TLS握手和HTTP 2.0通信过程：  
另外，在chrome中通过chrome://net-internals/#http2命令也能捕获HTTP 2.0通信过程：

7. HTTP 2.0性能瓶颈  

所有的压力集中在底层一个TCP连接之上，TCP很可能就是下一个性能瓶颈，比如TCP分组的队首阻塞问题，单个TCP packet丢失导致整个连接阻塞，无法逃避，此时所有消息都会受到影响。


## HTTP2.0只适用于HTTPS的场景

HTTPS是在HTTP和TCP之间增加了一层SSL，即secure socket layer，增加了数据安全传输及客户端和服务器端的身份验证，而HTTP2.0只适用于HTTPS的场景。