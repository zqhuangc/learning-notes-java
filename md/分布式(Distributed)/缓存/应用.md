缓存是分布式系统中的重要组件，主要解决高并发，大数据场景下，热点数据访问的性能问题。提供高性能的数据快速访问。



1、缓存的原理



- 将数据写入/读取速度更快的存储（设备）；
- 将数据缓存到离应用最近的位置；
- 将数据缓存到离用户最近的位置。



2、缓存分类



在分布式系统中，缓存的应用非常广泛，从部署角度有以下几个方面的缓存应用。



- CDN缓存；
- 反向代理缓存；
- 分布式Cache；
- 本地应用缓存；



3、缓存媒介



- 常用中间件：Varnish，Ngnix，Squid，Memcache，Redis，Ehcache等；
- 缓存的内容：文件，数据，对象；
- 缓存的介质：CPU，内存（本地，分布式），磁盘（本地，分布式）



4、缓存设计



缓存设计需要解决以下几个问题：



缓存什么？

哪些数据需要缓存：1.热点数据；2.静态资源。



缓存的位置？

CDN，反向代理，分布式缓存服务器，本机（内存，硬盘）



如何缓存的问题？

- 过期策略
- 固定时间：比如指定缓存的时间是30分钟；
- 相对时间：比如最近10分钟内没有访问的数据；
- 同步机制
- 实时写入；（推）
- 异步刷新；（推拉）



BSD系统

**分布式算法(Consistent Hashing)：**



选择服务器算法有两种，一种是根据余数来计算分布，另一种是根据散列算法来计算分布。



- 余数算法：



先求得键的整数散列值，再除以服务器台数，根据余数确定存取服务器。



优点：计算简单，高效。

缺点：在memcached服务器增加或减少时，几乎所有的缓存都会失效。



- 散列算法：（一致性Hash）



先算出memcached服务器的散列值，并将其分布到0到2的32次方的圆上，然后用同样的方法算出存储数据的键的散列值并映射至圆上，最后从数据映射到的位置开始顺时针查找，将数据保存到查找到的第一个服务器上，如果超过2的32次方，依然找不到服务器，就将数据保存到第一台memcached服务器上。



![img](https://mmbiz.qpic.cn/mmbiz_jpg/tibrg3AoIJTvXprHsxyliaBdS9JVicX0OEH4GPlYz4rO8m8JVVZvAJLUJOKic2KBib0VTFoqNjHNgjwDyHN4k8H1UVA/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

 

如果添加了一台Memcached服务器，只在圆上增加服务器的逆时针方向的第一台服务器上的键会受到影响。



一致性Hash算法：解决了余数算法增加节点命中大幅额度降低的问题，理论上，插入一个实体节点，平均会影响到：虚拟节点数 /2 的节点数据的命中。



通过keepalived实现的高可用方案

使用Twemproxy 实现集群方案





LVS+ HAproxy

![缓存架构](..\..\image\缓存应用.jpg)

**职责划分：**

CDN：存放HTML、CSS、JS等静态资源；

反向代理：动静分离，只缓存用户请求的静态资源；

分布式缓存：缓存数据库中的热点数据；

本地缓存：缓存应用字典等常用数据。



**请求过程：**

（1）浏览器向客户端发起请求，如果CDN有缓存则直接返回；

（2）如果CDN无缓存，则访问反向代理服务器；

（3）如果反向代理服务器有缓存则直接返回；

（4）如果反向代理服务器无缓存或动态请求，则访问应用服务器；

（5）应用服务器访问本地缓存；如果有缓存，则返回代理服务器，并缓存数据；（动态请求不缓存）

（6）如果本地缓存无数据，则读取分布式缓存；并返回应用服务器；应用服务器将数据缓存到本地缓存（部分）；

（7）如果分布式缓存无数据，则应用程序读取数据库数据，并放入分布式缓存。