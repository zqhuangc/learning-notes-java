连接池

连接池是创建和管理一个网络连接资源池的技术，这些连接一般预先准备好被任何需要它们的线程或者进程使用。

网络连接根据连接的生命周期可以粗略的分为两种：长链接和短链接。就web应用而言，短连接就是一般的http请求，长连接如websocket。

短链接适合大部分应用。对于远程方法的执行时间远大于连接创建时间(看网络情况大约为数毫秒)的时候，其连接创建时间可以被忽略，此时短连接策略基本不会有较大性能损失。另外，对于非频繁调用火灾对延迟时间不敏感的服务也适合使用短连接策略。 

对于高并发或者高吞吐量的应用，网络连接的创建消耗是很大的，对于这种应用应该使用长连接策略的连接池实现。


连接池中的几个常用参数
在各种连接池的实现中，常用的参数一般有：连接数相关，连接时间相关，有效性相关。

连接数
设计一个连接池，要确定池中的连接数量，包括最小空闲连接数，最大空闲连接数，连接池最大持有连接数。当然连接数可以变化，动态缩放，确定每次增加／减少的连接数量。

连接的有效性
保证连接池中的连接有效性，相当于增加了连接心跳的检测。同时，还有从池中获取客户端接口时的有效性，将客户端接口归还连接池时的有效性，当配置或实现了相关的管理服务，可以通过管理工具观察连接池的使用情况。例如对于Java的应用，如果配置了JMX服务的话，可以通过JMX管理工具观察Java连接池的状态。

连接有效性测试可以减少长连接失效造成的远程调用失败，对于那些对连接失效而造成的调用失败很敏感的服务，可以开启各种合适的连接有效性测试策略来保障所取得的客户端是连接正常的。

时间相关参数
为了保持池中连接的有效性，空闲连接检测时间也就是心跳间隔，这往往取决于业务使用连接池的场景。另外，还有从连接池中获取连接的最大等待时间，一般地默认为-1，即无可用连接会抛出异常，当设为0时表示无穷大。

网络通信连接池
网络通信的连接池主要节省创建TCP连接的时间，从而降低了请求的总处理时间。客户端为每个服务端实例维护一个连接池。如果连接池中有空闲连接，则复用这个连接。如果连接池中没有空闲连接，则会建立一个新的TCP连接或者等待池中出现空闲的连接。

当客户端使用池中连接处理完一个请求时，如果连接池中的空闲连接数小于连接池的大小，则将当前使用的连接放入连接池。 如果连接池中的空闲连接数大于等于连接池的大小，则关闭当前使用的连接。

面向http短连接的连接池，服务端支持keepalive时才有效，如果服务端关闭keepalive，则效果等同于短连接，就没有连接池的作用了。

同理，如果连接池的大小设置为0，也等同于短连接的方式。服务端支持Keepalive的时候，可以减少CPU和内存的使用，允许请求和应答的HTTP管道化，减少了后续请求的延迟，报告错误也无需关闭TCP连接。

一般地，对于延迟敏感的业务，可以使用连接池机制。